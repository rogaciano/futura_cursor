<!-- Seção de Cores/Variantes -->
<div class="bg-white p-6 rounded-lg shadow-md" x-data="coresManager()" x-init="init()">
    <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
        <svg class="w-5 h-5 mr-2 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01" />
        </svg>
        Cores/Variantes
        <span x-show="isDuplaDensidade" class="ml-2 px-2 py-1 bg-yellow-100 text-yellow-800 text-xs rounded-full">
            Dupla Densidade
        </span>
    </h3>
    
    <!-- Cor do Urdume -->
    <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-2">
            Cor do Urdume
        </label>
        <select 
            name="cor_urdume"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
        >
            <option value="nenhum">Nenhum</option>
            <option value="branco">Branco</option>
            <option value="preto">Preto</option>
            <option value="branco_preto">Branco e Preto</option>
            <option value="vermelho">Vermelho</option>
        </select>
    </div>
    
    <!-- Tabela de Cores -->
    <div class="mb-6">
        <h4 class="text-md font-semibold text-gray-700 mb-3">Cores</h4>
        
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Cor</th>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Código</th>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Unidades</th>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Dupla Densidade</th>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Total</th>
                        <th class="px-3 py-2"></th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    <template x-for="(cor, index) in cores1" :key="index">
                        <tr>
                            <td class="px-3 py-2">
                                <select 
                                    x-model="cor.posicao"
                                    class="w-full px-2 py-1 border border-gray-300 rounded text-sm"
                                >
                                    <option value="Fd">Fd (Fundo)</option>
                                    <option value="1">1ª</option>
                                    <option value="2">2ª</option>
                                    <option value="3">3ª</option>
                                    <option value="4">4ª</option>
                                    <option value="5">5ª</option>
                                    <option value="6">6ª</option>
                                    <option value="7">7ª</option>
                                </select>
                            </td>
                            <td class="px-3 py-2">
                                <input 
                                    type="text"
                                    x-model="cor.codigo"
                                    placeholder="Ex: F01, T30"
                                    class="w-full px-2 py-1 border border-gray-300 rounded text-sm"
                                />
                            </td>
                            <td class="px-3 py-2">
                                <input 
                                    type="number"
                                    x-model.number="cor.unidades"
                                    min="0"
                                    class="w-20 px-2 py-1 border border-gray-300 rounded text-sm"
                                />
                            </td>
                            <td class="px-3 py-2">
                                <input
                                    type="number"
                                    x-model.number="cor.demais"
                                    min="0"
                                    :disabled="!isDuplaDensidade"
                                    class="w-20 px-2 py-1 border border-gray-300 rounded text-sm"
                                    :class="{ 'bg-gray-100 cursor-not-allowed': !isDuplaDensidade }"
                                />
                            </td>
                            <td class="px-3 py-2">
                                <span class="font-semibold text-gray-700" x-text="cor.unidades + cor.demais"></span>
                            </td>
                            <td class="px-3 py-2">
                                <button 
                                    type="button"
                                    @click="removerCor1(index)"
                                    class="text-red-600 hover:text-red-800"
                                >
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                    </svg>
                                </button>
                            </td>
                        </tr>
                    </template>
                    <tr class="bg-yellow-50">
                        <td colspan="2" class="px-3 py-2 font-semibold text-gray-700">Total:</td>
                        <td class="px-3 py-2 font-bold text-blue-600" x-text="totalUnidades1"></td>
                        <td class="px-3 py-2 font-bold text-blue-600" x-text="totalDemais1"></td>
                        <td class="px-3 py-2 font-bold text-green-600" x-text="totalGeral1"></td>
                        <td></td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <button
            type="button"
            @click="adicionarCor1()"
            class="mt-2 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition text-sm"
        >
            + Adicionar Cor
        </button>
    </div>
    
    <!-- Campos hidden para envio do formulário -->
    <input type="hidden" name="cores_data" :value="JSON.stringify({cores1})">
</div>

<script>
function coresManager() {
    return {
        cores1: [
            { posicao: 'Fd', codigo: '', unidades: 0, demais: 0 }
        ],
        isDuplaDensidade: false,

        get totalUnidades1() {
            return this.cores1.reduce((sum, cor) => sum + (cor.unidades || 0), 0);
        },

        get totalDemais1() {
            return this.cores1.reduce((sum, cor) => sum + (cor.demais || 0), 0);
        },

        get totalGeral1() {
            return this.totalUnidades1 + this.totalDemais1;
        },

        adicionarCor1() {
            this.cores1.push({ posicao: '1', codigo: '', unidades: 0, demais: 0 });
        },

        removerCor1(index) {
            if (this.cores1.length > 1) {
                this.cores1.splice(index, 1);
            }
        },
        
        // Observa mudanças no material para detectar Dupla Densidade
        init() {
            console.log('[CORES] Inicializando coresManager...');
            const materialSelect = document.querySelector('select[name="tipo_material"]');
            if (materialSelect) {
                console.log('[CORES] Material select encontrado, valor atual:', materialSelect.value);
                materialSelect.addEventListener('change', () => {
                    console.log('[CORES] Material alterado para:', materialSelect.value);
                    this.checkDuplaDensidade(materialSelect.value);
                });

                // Verifica inicial
                if (materialSelect.value) {
                    console.log('[CORES] Verificando dupla densidade inicial para material:', materialSelect.value);
                    this.checkDuplaDensidade(materialSelect.value);
                }
            } else {
                console.warn('[CORES] Material select NÃO encontrado!');
            }

            // Carregar cores existentes (modo edição)
            {% if cores1_json %}
            try {
                const coresExistentes1 = {{ cores1_json|safe }};
                console.log('[CORES] Carregando cores1:', coresExistentes1);
                if (coresExistentes1 && coresExistentes1.length > 0) {
                    this.cores1 = coresExistentes1;
                }
            } catch(e) {
                console.error('[CORES] Erro ao carregar cores 1:', e);
            }
            {% endif %}
        },

        checkDuplaDensidade(materialId) {
            console.log('[CORES] checkDuplaDensidade chamado com materialId:', materialId);
            if (!materialId) {
                console.log('[CORES] MaterialId vazio, definindo isDuplaDensidade = false');
                this.isDuplaDensidade = false;
                this.zerarDuplaDensidade();
                return;
            }

            const url = `/api/material/${materialId}/info/`;
            console.log('[CORES] Fazendo fetch para:', url);

            // Busca informação do material via AJAX
            fetch(url)
                .then(response => {
                    console.log('[CORES] Response status:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('[CORES] Dados recebidos:', data);
                    this.isDuplaDensidade = data.dupla_densidade || false;
                    console.log('[CORES] isDuplaDensidade definido como:', this.isDuplaDensidade);

                    // Se não for dupla densidade, zerar todos os valores
                    if (!this.isDuplaDensidade) {
                        this.zerarDuplaDensidade();
                    }
                })
                .catch(error => {
                    console.error('[CORES] Erro ao buscar informações do material:', error);
                    this.isDuplaDensidade = false;
                    this.zerarDuplaDensidade();
                });
        },

        zerarDuplaDensidade() {
            console.log('[CORES] Zerando valores de dupla densidade');
            // Zerar o campo "demais" de todas as cores
            this.cores1.forEach(cor => {
                cor.demais = 0;
            });
        }
    }
}
</script>

